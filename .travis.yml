# This builds multiple projects
# 1. the "one-app" of the Book Monkey2 - all components are tied togehter in one big app with explanations
# 2. single apps for each iteration/increment

language: node_js

node_js:
  - '4.2'
  
env:
  global:
    # node-gyp: Node.js v4 (or io.js v3) compiler requirements
    # https://docs.travis-ci.com/user/languages/javascript-with-nodejs#Node.js-v4-(or-io.js-v3)-compiler-requirements
    - CXX=g++-4.8  
    - GITHUB_ORG="https://GH_TOKEN@github.com/book-monkey2-build"
    - GITHUB_NAME="The Buildbot"
    - GITHUB_EMAIL="buildbot@angular2buch.de"
  matrix:
    - NAME="one-app"
    - NAME="iteration-1-book-details"  BLUEPRINT="src/client/app/book-monkey/iteration-1/book-details"
    - NAME="iteration-1-book-list"     BLUEPRINT="src/client/app/book-monkey/iteration-1/book-list"

install:
  # speeds up install time
  - npm uninstall book-monkey2-api --save-dev
  - npm install

script:
  - echo $NAME

  # [1] one-app:
  # - fills /dist folder and adds CNAME file as well as 404 file for gh-pages
  # - sends compiled version to gh-pages
  # TODO: npm run ng test  
  - if [ "$NAME" == "one-app" ]; then 
      npm run ng build;
      echo "book-monkey2.angular2buch.de" > dist/CNAME;
      cp dist/index.html dist/404.html;
      npm run ng -- ghpages --repo="$GITHUB_ORG/$NAME.git" --name="$GITHUB_NAME" --email="$GITHUB_EMAIL"  --silent=false;
    fi

  # [2]
  # - creates multiple single apps
  # - sends uncompiled version to master
  - if [ "$NAME" != "one-app" ]; then 
      cd ..;
      mkdir TMP;
      cd TMP || exit;
      node "$TRAVIS_BUILD_DIR/node_modules/angular-cli/bin/ng" new BookMonkey;
      cd BookMonkey;
      rm -rf .git;
      cd "$TRAVIS_BUILD_DIR" || exit;
      echo "*** DIRECTORY LISTING OF $TRAVIS_BUILD_DIR/$BLUEPRINT ***";
      ls -a "$TRAVIS_BUILD_DIR/$BLUEPRINT";
      cp -rf "$TRAVIS_BUILD_DIR/$BLUEPRINT/." "$TRAVIS_BUILD_DIR/../TMP/BookMonkey/src/client/app/";
      echo "*** DIRECTORY LISTING OF $TRAVIS_BUILD_DIR/../TMP/BookMonkey ***";
      ls -a "$TRAVIS_BUILD_DIR/../TMP/BookMonkey";
      npm run ng -- ghpages --repo="$GITHUB_ORG/$NAME.git" --name="$GITHUB_NAME" --email="$GITHUB_EMAIL" --dir=../TMP/BookMonkey --branch=master --silent=false;
    fi
  
# ---- boilerplate ----

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8

# a build will finish as soon as a job has failed      
matrix:
  fast_finish: true       
  
#only building specific branches  
branches:
  only:
    - master
    - refactoring-all-it